<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–∫—Ä–∏–ø—Ç—ã</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1, h2 {
      color: #333;
    }

    ul.script-list {
      list-style-type: none;
      padding-left: 0;
    }

    ul.script-list li {
      padding: 10px;
      margin-bottom: 8px;
      background-color: #f9f9f9;
      border-radius: 4px;
      display: flex;
      align-items: center;
    }

    ul.script-list li label {
      cursor: pointer;
      flex-grow: 1;
    }

    ul.script-list li input[type="checkbox"] {
      margin-right: 10px;
    }

    .selected-count {
      margin-top: 10px;
      font-weight: bold;
    }

    #drop-area {
      border: 2px dashed #ccc;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
      color: #555;
      cursor: pointer;
    }

    #drop-area.hover {
      border-color: #007BFF;
      background-color: #e6f1ff;
    }

    .btn {
      margin-top: 30px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
    }

    .btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

  <h1>–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤</h1>

  <ul class="script-list" id="script-list">
    {% if scripts %}
      {% for script in scripts %}
        <li>
          <input type="checkbox" id="script-{{ loop.index }}" name="scripts" value="{{ script }}">
          <label for="script-{{ loop.index }}">{{ script }}</label>
        </li>
      {% endfor %}
    {% else %}
      <p>–°–∫—Ä–∏–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
    {% endif %}
  </ul>

  <div class="selected-count" id="selected-count">–í—ã–±—Ä–∞–Ω–æ: 0 —Ñ–∞–π–ª–æ–≤</div>

  <h2>üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</h2>
  <div id="drop-area">
    –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å
    <input type="file" id="fileElem" multiple style="display:none">
  </div>

  <button class="btn" onclick="saveAndRun()">‚ñ∂Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>

  <script>
    const scriptList = document.getElementById("script-list");
    const selectedCount = document.getElementById("selected-count");
    const fileInput = document.getElementById("fileElem");
    const dropArea = document.getElementById("drop-area");

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    function updateSelectedCount() {
      const count = document.querySelectorAll('input[name="scripts"]:checked').length;
      selectedCount.textContent = "–í—ã–±—Ä–∞–Ω–æ: " + count + " —Ñ–∞–π–ª–æ–≤";
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ —Å–ø–∏—Å–æ–∫
    function addScriptToList(fullPath, file) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ñ–∞–π–ª
      const exists = Array.from(scriptList.querySelectorAll("input")).some(
        el => el.value === fullPath
      );
      if (exists) return;

      const li = document.createElement("li");

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = "scripts";
      checkbox.id = "upload-" + Date.now() + "-" + Math.random().toString(36).substr(2, 5);
      checkbox.value = fullPath;

      checkbox.addEventListener("change", updateSelectedCount);

      const label = document.createElement("label");
      label.setAttribute("for", checkbox.id);
      label.textContent = fullPath;

      li.appendChild(checkbox);
      li.appendChild(label);

      scriptList.appendChild(li);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
    function handleFiles(files, e) {
      const items = e?.dataTransfer?.items;

      if (items) {
        for (let i = 0; i < items.length; i++) {
          const item = items[i].webkitGetAsEntry();
          if (item && item.isFile) {
            item.file(file => {
              const fullPath = item.fullPath || file.name;
              addScriptToList(fullPath, file);
            });
          }
        }
      } else {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fullPath = file.webkitRelativePath || file.name;
          addScriptToList(fullPath, file);
        }
      }

      updateSelectedCount();
    }

    // Drag & Drop —Å–æ–±—ã—Ç–∏—è
    dropArea.addEventListener("click", () => fileInput.click());

    ["dragenter", "dragover"].forEach(eventName => {
      dropArea.addEventListener(eventName, e => {
        e.preventDefault();
        dropArea.classList.add("hover");
      });
    });

    ["dragleave", "drop"].forEach(eventName => {
      dropArea.addEventListener(eventName, e => {
        e.preventDefault();
        dropArea.classList.remove("hover");
      });
    });

    dropArea.addEventListener("drop", e => {
      const files = e.dataTransfer.files;
      handleFiles(files, e);
    });

    fileInput.addEventListener("change", e => {
      const files = e.target.files;
      handleFiles(files, e);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á—ë—Ç—á–∏–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.querySelectorAll('input[name="scripts"]').forEach(cb => {
      cb.addEventListener("change", updateSelectedCount);
    });
    updateSelectedCount();

    // saveAndRun ‚Äî –ø–æ–ª—É—á–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –∏ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    async function saveAndRun() {
      const checked = document.querySelector('input[name="scripts"]:checked');
      if (!checked) {
        alert("‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ.");
        return;
      }

      const path = checked.value;

      // –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π File-–æ–±—ä–µ–∫—Ç
      const fileInput = document.getElementById("fileElem");
      const file = Array.from(fileInput.files).find(f =>
        f.webkitRelativePath === path || f.name === path
      );

      if (!file) {
        alert("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.");
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        const content = e.target.result;

        // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏–º —Ç–µ–∫—É—â–∏–π —Å–∫—Ä–∏–ø—Ç
        const saveResponse = await fetch("/script/save", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ script_path: path, script_content: content })
        });

        if (!saveResponse.ok) {
          alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç");
          return;
        }

        // –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏–º –∞–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const runResponse = await fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ script_path: path, max_retries: 5 })
        });

        const result = await runResponse.json();
        if (result.status === "success") {
          alert("‚úÖ –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!");
          window.location.href = "/";
        } else {
          alert("üîÑ –ò–ò –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç...");
          window.location.href = "/run";
        }
      };

      reader.readAsText(file);
    }
  </script>

</body>
</html>